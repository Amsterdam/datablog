---
title: "360-gradenfoto’s van de hele stad: op ontdekkingsreis in Amsterdam"
lang: nl
ref: panorama
author: bert
---

Welke [trotse vogel op de Hoogte Kadijk](https://data.amsterdam.nl/data/panorama/TMX7316010203-000719_pano_0000_001659/?modus=volledig&center=52.3688592%2C4.9167371&heading=-21.465765996101748&lagen=pano%3A1&locatie=52.3688591932923%2C4.91673710537651&pitch=-14.925156155458305) herinnert aan een roemruchte brouwerij die daar ooit stond? Wat staat er in [de letterbak op de gevel van de Dubbeltjespanden](https://data.amsterdam.nl/data/panorama/TMX7316010203-000744_pano_0000_000011/?center=52.3618283%2C4.9171022&heading=-165&locatie=52.3618282840258%2C4.91710223576424&modus=volledig) aan de Mauritskade? [Wie houdt braaf de wacht](https://data.amsterdam.nl/data/panorama/TMX7316010203-000786_pano_0001_000001/?modus=volledig&center=52.3510725%2C4.8499076&detail-ref=0363300000003585%2Cbag%2Copenbareruimte&heading=-17.922882484126273&lagen=pano%3A1&locatie=52.3510724634293%2C4.8499075858745&pitch=13.062677418649113) op het Hoofddorpplein? De antwoorden vind je op data.amsterdam.nl, waar je vanaf bijna ieder punt in de stad 360 graden in het rond kunt kijken.

Op [data.amsterdam.nl](https://data.amsterdam.nl/data/panorama/TMX7316060226-000012_pano_0000_004024/?heading=-139&pitch=-22.8) zijn 360-gradenfoto’s van de hele gemeente Amsterdam beschikbaar (en zelfs daarbuiten). Vanaf elke weg, elk fietspad, elke gracht en elk kanaal is gefotografeerd; met je browser ben je zo in [Landelijk Noord](https://data.amsterdam.nl/data/panorama/TMX7315120208-000038_pano_0002_001693/?modus=volledig&heading=44.75&pitch=-25.48), in [het Amsterdamse Bos](https://data.amsterdam.nl/data/panorama/TMX7316010203-000115_pano_0001_001022/?modus=volledig&heading=-106), of in [de havens van Westpoort](https://data.amsterdam.nl/data/panorama/TMX7316010203-000173_pano_0003_000028/?modus=volledig&heading=177&pitch=-9) tussen de olietankers. Deze panoramafoto’s van Amsterdam en hun metadata zijn beschikbaar als open data. In deze post laten we zien hoe je deze afbeeldingen kunt gebruiken, en, leuker nog, wat je ermee kan maken!

Voor de dagelijkse werkzaamheden van veel gemeentemedewerkers is het van belang om te weten hoe de stad eruit ziet. Samen met kaarten en luchtfoto’s helpen panoramafoto’s, gemaakt vanaf de straat op ooghoogte, bijvoorbeeld bij het beoordelen van vergunningsaanvragen en het herinrichten van straten en kruispunten Ze zouden daarvoor natuurlijk [Google Street View](https://www.google.com/maps/@52.3885574,4.8901644,3a,60y,185.21h,104.13t/data=!3m6!1e1!3m4!1sg8ZYRrNPP_HV-geiL-RgOg!2e0!7i13312!8i6656) kunnen gebruiken. Maar het Google-autootje komt niet in parken, op fiets- en wandelpaden, in stegen, op de grachten of in wijken in aanbouw. Bovendien bepaalt Google zélf wanneer ze ergens nieuwe foto’s maken, en mogen de foto’s niet voor andere doeleinden gebruikt worden.

Sinds 2016 heeft Amsterdam een eigen panoramacamera die bovenop een auto of een schip gemonteerd kan worden. Straat voor straat en gracht voor gracht wordt de stad elk jaar opnieuw vastgelegd. Sinds 2016 zijn er meer dan 2,5 miljoen foto’s gemaakt en is meer dan 14,000 kilometer weg en kade gefotografeerd. Ook de gemeentes Weesp, Almere en Amstelveen doen mee met dit project en maken gebruik van de camera en de foto’s. Na een dag op straat of op het water worden de afbeeldingen en GPS-data uitgelezen waarna ze automatisch op data.amsterdam.nl belanden. Deze methode maakt het mogelijk snel en efficient grote stukken van de stad in één dag te fotograferen.

{% include figure.liquid
  caption="<a href=\"https://data.amsterdam.nl/data/panorama/TMX7315120208-000038_pano_0002_001691/?center=52.3927943%2C4.9932496&heading=34.45&locatie=52.3927943%2C4.9932496&pitch=-27.75&zoom=13\">Panoramafoto van de kerk van Ransdorp in data.amsterdam.nl</a>."
  alt="Panoramafoto van de kerk van Ransdorp in data.amsterdam.nl"
  src="ransdorp.jpg" %}

Al voor de uitvinding van GPS en digitale fotografie was er uiteraard ook behoefte aan vergelijkbare foto’s. De gemeente New York heeft tweemaal, eind jaren 30 en halverwege de jaren 80, fotografen op pad gestuurd om elk gebouw en perceel te laten fotograferen. Deze foto’s zijn onlangs gedigitaliseerd en online te bekijken. Zie bijvoorbeeld [Every Building on Every Block: A Time Capsule of 1930s New York](https://www.nytimes.com/interactive/2018/12/28/nyregion/nyc-property-tax-photos.html) en [80s.NYC](http://80s.nyc/).

{% include full-width-start.liquid %}
{% include figure.liquid
  caption="<a href=\"https://data.amsterdam.nl/data/panorama/TMX7316010203-000173_pano_0008_000608/?modus=volledig&heading=-116&pitch=-2.3\">Panoramafoto genomen vanaf een schip in Zijkanaal H</a>"
  alt="Panoramafoto genomen vanaf een schip in Zijkanaal H"
  src="zijkanaal-h.jpg" %}
{% include full-width-end.liquid %}

Terug naar Amsterdam: we tonen inmiddels een panoramafoto bij elke selectie en zoekopdracht in het dataportaal. Maar omdat de foto’s beschikbaar zijn als open data kunnen we er veel meer mee doen! Zo testen we bijvoorbeeld software om automatisch verkeersborden en andere objecten in de openbare ruimte op de foto’s te herkennen. Maar het leukste is misschien wel om de foto’s te gebruiken om Amsterdam te ontdekken en op plekken te komen waar je anders niet snel komt. Als je maar lang genoeg met Google Street View de wereld over reist kom je de gekste dingen tegen, zoals arrestaties, ongelukken en ontsnapte dieren. Dit soort Street View-reisreportages zijn populair, zie bijvoorbeeld [9-Eyes](http://9-eyes.com/) en [A Series of Unfortunate Events](http://photomichaelwolf.com/#asoue/1). Ook erg leuk is GeoGuessr, een website die je op een willekeurige plek in de wereld dropt. Aan de hand van het straatbeeld moet je raden waar je bent. Hoe dichterbij, hoe beter. Als je geluk hebt zie je verkeersborden maar soms ben je aangewezen op de vegetatie of bouwstijl van huizen.

__In deze post gaan we een Amsterdamse versie van GeoGuessr maken, zonder Google, maar met open source-tools en Amsterdamse open data!__

{% include figure.liquid
  caption="Raad waar op de wereld je bent: <a href=\"https://geoguessr.com/world/play\">GeoGuessr</a> met Google Street View."
  alt="GueGuessr"
  src="geoguessr.jpg" %}

## Op ontdekkingsreis in Amsterdam

Aan de slag! Met de webservices van data.amsterdam.nl en wat kennis van webtechnologie en JavaScript-frameworks maken we zo ons eigen online _panorama-dropping-spel_. Hoe beginnen we?

1. Ten eerste moeten we een manier vinden om steeds van een willekeurige plek in Amsterdam een panoramafoto te downloaden;
2. Deze foto kunnen we vervolgens laten zien met [Marzipano](http://www.marzipano.net/);
3. [Leaflet](https://leafletjs.com/) zorgt dat spelers kunnen raden waar ze zijn, met een kaartlaag uit het dataportaal;
4. Met [Turf.js](https://turfjs.org/docs/#distance) kunnen we uitrekenen of de speler in de buurt is van de echte fotolocatie;
5. Een simpele webapplicatie, gemaakt met [Vue](https://vuejs.org/), voegt alles samen.
6. Klaar! We kunnen op ontdekkingsreis in Amsterdam!

## De panoramafoto van een willekeurige plek in Amsterdam

De eerste stap is gelijk de moeilijkste. De panoramafoto’s kunnen worden gezocht en benaderd via de REST API op [api.data.amsterdam.nl/panorama](https://api.data.amsterdam.nl/panorama). Met deze API is het ook mogelijk om de foto te vinden die het dichtst bij een bepaalde geografische locatie ligt. In het voorbeeld hieronder zie je doe dit gaat met JavaScript en [axios](https://github.com/axios/axios), maar het kan uiteraard met elke willekeurige programmeertaal:

```js
const lonLat = [4.96165, 52.38250]
const apiUrl = 'https://api.data.amsterdam.nl/panorama/panoramas/'
const url =  `${apiUrl}?near=${lonLat.join(',')}&srid=4326&radius=250&page_size=1`

return axios.get(url)
  .then((response) => response.data)
  .then((data) => {
    // Als er een foto gevonden is hebben we nu
    // alle metadata en links naar de foto:
    console.log(data)
  })
```

Je kunt de JSON-data die deze API-call teruggeeft ook [bekijken in de browser](https://api.data.amsterdam.nl/panorama/panoramas/?near=4.96165,52.38250&srid=4326&radius=250&page_size=1). En als je met de API wilt spelen, en de foto’s en de data direct wilt bekijken kun je dit [Observable-notebook](https://observablehq.com/@bertspaan/nearest-panorama-photo) gebruiken.

Via de Panorama-API is het mogelijk om een foto te zoeken in de buurt van een locatie. Echter, het kiezen van een willekeurige locatie in de gemeente Amsterdam is niet zo eenvoudig. De meest simpele oplossing is om steeds een punt te kiezen in de rechthoek waar de [gemeentegrenzen van Amsterdam](https://maps.amsterdam.nl/gebiedsindeling/) precies inpassen, grofweg tussen Uitdam, Nederhorst den Berg, Hoofddorp en Assendelft. Omdat dit gebied veel groter is dan de gemeente zelf, zul je relatief vaak een punt kiezen wat ver buiten de stad ligt. De foto hier het dichtst bij is er dan een van de rand van de stad. Deze methode zal er dus voor zorgen dat je steeds aan de rand van de stad wordt neergezet, middenin het groen. Ook als we de precieze omtrek van de gemeente gebruiken om een willekeurig punt te kizen hebben we hetzelfde probleem: er zijn niet overal panoramafoto’s gemaakt, en ook dan zullen de lege gebieden ons te vaak op een afgelegen plek afzetten. We zouden ook een kleine zoekradius kunnen gebruiken, en de zoekopdracht kunnen blijven herhalen tot een foto gevonden is, maar dat is helemaal een onaantrekkelijke oplossing.

Alleen door alle routes te bekijken waarlangs foto’s genomen zijn, en een willekeurig punt te kiezen langs een van deze routes, kunnen we op de correcte manier een willekeurige panoramafoto kiezen. Deze methode levert bovendien ook een mooie datavisualisatie van alle gefotografeerde routes op!

Via de Panorama-API of via de [WFS-server](https://map.data.amsterdam.nl/maps/panorama?REQUEST=GetCapabilities&SERVICE=wfs) kunnen we alle opnamelocaties downloaden. Aan de hand van het ID en het tijdstip van een foto is af te leiden welke foto’s bij elkaar horen en achter elkaar genomen zijn. Voor deze post hebben we speciaal een dataset gemaakt van alle routes. [Deze dataset staat op GitHub](https://github.com/Amsterdam/panorama-visualization) en bevat GeoJSON-bestanden en _vector tiles_.

{% include full-width-start.liquid %}
{% include iframe.liquid
  src="https://amsterdam.github.io/panorama-visualization" class="vh-100"
  caption="Visualisatie van alle routes waarlangs panoramafoto’s genomen zijn." %}
{% include full-width-end.liquid %}

Vervolgens kunnen we deze routes openen met [QGIS](https://qgis.org/), van de lijnen polygonen maken, deze polygonen samenvoegen, en het stuk dat niet binnen de gemeente Amsterdam valt verwijderen. Met QGIS kan dit op de volgende manier:

1. Download `sequences.geojson` van [GitHub](https://github.com/Amsterdam/panorama-visualization)), en open dit bestand met QGIS;
2. Kies _Vector_ ⟶ _Geoprocessing Tools_ ⟶ _Buffer…_ om een rand van een aantal meter dik om de lijnen te genereren en er zo polygonen van te maken. Hoe dikker deze rand, hoe vaker we in gebieden terecht zullen komen waar geen foto’s gemaakt zijn. Als de rand te dun is worden routes waar meerdere keren foto’s zijn genomen maar niet precies op elkaar liggen niet samengevoegd, en zullen straten die vaker gefotografeerd zijn vaker worden gekozen. In dit voorbeeld hebben we voor een afstand van 200 meter gekozen. __Belangrijk: de bewerkingen kunnen het beste worden uitgevoerd in EPSG:28992 (ofwel Rijksdriehoekscoördinaten), alle afstanden zijn dan in meters.__
3. Kies vervolgens _Vector_ ⟶ _Geoprocessing Tools_ ⟶ _Dissolve…_ om de losse polygonen samen te voegen tot één vorm.
4. Open `gemeente-amsterdam.geojson` (wederom te vinden in het GitHub-project), met _Vector_ ⟶ _Geoprocessing Tools_ ⟶ _Intersection…_ kunnen we het stuk van de samengevoegde polygonen die buiten Amsterdam liggen verwijderen.

{% include figure.liquid
  caption="Alle panorama-routes, samengevoegd, en met een extra rand van 200 meter breed."
  alt="Panoramaroutes in QGIS"
  src="qgis.jpg" %}

We zijn er bijna! Het enige dat nog ontbreekt is een algoritme om een willekeurige punt in een polygoon te selecteren. Voor rechthoeken en driehoeken is dit eenvoudig, maar complexere veelhoeken is er een extra stap nodig. Door de polygoon eerst op te delen in driehoeken, en bij elke zoekopdracht naar een nieuwe panoramafoto eerst een willekeurige driehoek te kiezen en dan een willekeurig punt in die driehoek, hebben we een efficiente en elegante manier om een willekeurige panoramafoto in Amsterdam te vinden. Let wel: we kunnen niet zomaar een willekeurige driehoek te kiezen, maar we moeten grotere driehoeken vaker kiezen dan kleine. Wie meer wil lezen over dit algoritme verwijzen we wederom naar een [Observable-notebook](https://observablehq.com/@scarysize/finding-random-points-in-a-polygon).

{% include figure.liquid
  caption="De oppervlakte onderverdeeld in driehoeken met een <a href=\"https://nl.wikipedia.org/wiki/Delaunay-triangulatie\">Delaunay-triangulatie</a>
."
  alt="triangulation"
  src="sequences-triangulation.svg" %}

Het opdelen van polygonen in driehoeken kan op veel manieren. Het kan in de browser met JavaScript, bijvoorbeeld met [Earcut](https://github.com/mapbox/earcut). Wij kozen wederom voor QGIS:

1. Maak eerst losse punten van de polyoon: _Vector_ ⟶ _Geometry Tools_ ⟶ _Extract Vertices…_.
2. Daarna kan van deze punten een [Delaunay-triangulatie](https://nl.wikipedia.org/wiki/Delaunay-triangulatie) worden berekend: _Vector_ ⟶ _Geometry Tools_ ⟶ _Delaunau Triangulation…_
3. Als laatste gebruiken we weer een _Intersection_ om de gaten uit de triangulatie te knippen.

Het resultaat kunnen we nu exporteren als GeoJSON, en gebruiken in de webapplicatie. Kies altijd de projectie EPSG:4326 als je GEOJSON-bestanden exporteert voor gebruik op het web!

## Marzipano, Leaflet en Turf.js

De webapplicatie bestaat uit twee onderdelen: de gebruikers zien de panoramafoto zo groot mogelijk in beeld. Rechtsonder in beeld staat een kleine kaart waarmee de locatie van de foto kan worden gezocht. [Marzipano](http://www.marzipano.net/) kan als volgt worden toegevoegd:

```js
var marzipanoElement = document.getElementById('marzipano')

var viewerOptions = {
  stageType: null,
  stage: {
    preserveDrawingBuffer: true,
    width: 960
  }
}

var viewer = new Marzipano.Viewer(marzipanoElement, viewerOptions)

// panoramaImage bevat een object van de Panorama-API
var source = Marzipano.ImageUrlSource
  .fromString(panoramaImage.cubic_img_pattern, {
    cubeMapPreviewUrl: panoramaImage._links.cubic_img_preview.href
  })

var initialView = {
  yaw: Math.random() * 360,
  fov: 90 * Math.PI / 180,
  pitch: 0,
}

var viewLimiter = Marzipano
  .RectilinearView
  .limit.traditional(12 * 1024, Math.PI / 2)

var view = new Marzipano.RectilinearView(initialView, viewLimiter)

var levelPropertiesList = [{
  tileSize: 256,
  size: 256,
  fallbackOnly: true
}, {
  tileSize: 512,
  size: 512
}, {
  tileSize: 512,
  size: 1024
}, {
  tileSize: 512,
  size: 2048
}]

var scene = this.viewer.createScene({
  source,
  geometry: new Marzipano.CubeGeometry(levelPropertiesList),
  view,
  pinFirstLevel: true
})

scene.switchTo()
```

{% include figure.liquid
  caption="Een Amsterdamse panoramafoto, weergegeven met Marzipano (waar is dit?)."
  alt="Een Amsterdamse panoramafoto, weergegeven met Marzipano"
  src="marzipano.jpg" %}

Op [het dataportaal](https://api.data.amsterdam.nl/api/) zijn naast webservices ook kaarttiles en luchtfoto’s te vinden. Met [Leaflet](https://leafletjs.com/) gebruik je deze zo:

```js
var mapElement = document.getElementById('map')
var map = L.map(mapElement).setView([52.369, 4.922], 12)

var tileUrl = 'https://{s}.data.amsterdam.nl/topo_wm_light/{z}/{x}/{y}.png'

L.tileLayer(tileUrl, {
  subdomains: ['t1', 't2', 't3', 't4'],
  maxZoom: 19
}).addTo(map)
```

Als de speler denkt te weten waar de foto genomen is kunnen we met [Turf.js](http://turfjs.org/docs/#distance) uitrekenen wat de afstand in meters is tussen deze locatie en de plek waar de foto genomen is.

## Waar ben ik?

Nu moeten alles wat hierboven beschreven is samenvoegen tot een webapplicatie. Uiteindelijk heeft ons spel ook een goede naam nodig, maar laten we voorlopig __Waar ben ik?__ als naam gebruiken. Voor wie precies wil weten hoe de applicatie, gemaakt met [Vue.js](https://vuejs.org/), in elkaar zit kan [op GitHub kijken](https://github.com/bertspaan/waar-ben-ik).

We hebben al genoeg technologie besproken in deze post, we kunnen 't spel beter gaan spelen: __[bertspaan.nl/waar-ben-ik](https://bertspaan.nl/waar-ben-ik)__.

{% include figure.liquid
  caption="<a href=\"https://github.com/bertspaan/waar-ben-ik\">Waar ben ik?</a>"
  alt="Waar ben ik?"
  src="waar-ben-ik.jpg" %}

__Wie wil meehelpen om van _Waar ben ik?_ een multiplayer-spel te maken? Stuur een bericht op [Twitter](https://twitter.com/bertspaan)!__
